<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사장님 플러스 헬프센터</title>
    <link rel="icon" type="image/jpeg" href="../favicon-32x32.jpg">
    <link rel="icon" type="image/jpeg" sizes="16x16" href="../favicon-16x16.jpg">
    <link rel="icon" type="image/jpeg" sizes="32x32" href="../favicon-32x32.jpg">
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        surface: {
                            50: '#fafafa',
                            100: '#f5f5f5',
                            200: '#e5e5e5',
                            300: '#d4d4d4',
                            400: '#a3a3a3',
                            500: '#737373',
                        }
                    }
                }
            }
        }
    </script>
    <!-- XLSX 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Modern responsive design variables */
        :root {
            --sidebar-width: 320px;
            --admin-panel-width: 320px;
            --collapsed-width: 56px;
            --mobile-breakpoint: 768px;
            --transition-speed: 0.3s;
        }

        /* Responsive grid layout */
        .app-container {
            display: grid;
            grid-template-columns: var(--sidebar-width) var(--admin-panel-width) 1fr;
            grid-template-areas: "sidebar admin content";
            height: 100vh;
            transition: grid-template-columns var(--transition-speed) ease;
        }

        /* Mobile layout */
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-areas: "content";
            }
            
            .sidebar-mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
                display: none;
            }
            
            .sidebar-mobile-overlay.active {
                display: block;
            }
            
            .mobile-sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 280px;
                height: 100vh;
                z-index: 50;
                transition: left var(--transition-speed) ease;
                background: white;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }
            
            .mobile-sidebar.active {
                left: 0;
            }
            
            .mobile-header {
                display: flex;
                align-items: center;
                justify-content: between;
                padding: 1rem;
                background: white;
                border-bottom: 1px solid #e5e7eb;
                position: sticky;
                top: 0;
                z-index: 30;
            }
            
            .hamburger-btn {
                display: block;
                padding: 8px;
                background: none;
                border: none;
                cursor: pointer;
            }
            
            .hamburger-btn span {
                display: block;
                width: 20px;
                height: 2px;
                background: #374151;
                margin: 3px 0;
                transition: 0.3s;
            }
        }

        @media (min-width: 769px) {
            .mobile-header {
                display: none;
            }
            
            .hamburger-btn {
                display: none;
            }
        }

        /* Enhanced animations and transitions */
        .function-selected {
            background: linear-gradient(90deg, #dbeafe 0%, #eff6ff 100%) !important;
            border-left: 4px solid #2563eb !important;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        }
        
        .admin-selected {
            background: linear-gradient(90deg, #dcfce7 0%, #f0fdf4 100%) !important;
            border-left: 4px solid #16a34a !important;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(22, 163, 74, 0.15);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        /* Improved sidebar styles */
        .sidebar-collapsed {
            width: var(--collapsed-width) !important;
        }
        
        .sidebar-collapsed .sidebar-text {
            opacity: 0;
            transform: translateX(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
        }
        
        .sidebar-collapsed .sidebar-icon {
            margin: 0 auto;
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }

        /* Enhanced hover effects */
        .function-toggle {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 2px 8px;
        }
        
        .function-toggle:hover {
            background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%);
            transform: translateX(2px);
        }

        /* Modern toggle button */
        .toggle-btn {
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
        }
        
        .toggle-btn:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        /* Smooth transitions for all interactive elements */
        .sidebar-transition {
            transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .admin-panel-collapsed {
            width: var(--collapsed-width) !important;
        }
        
        .admin-panel-collapsed .admin-text {
            opacity: 0;
            transform: translateX(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
        }
        
        .admin-panel-collapsed .admin-item > div {
            justify-content: center !important;
        }
        
        .admin-panel-collapsed .bg-blue-100 {
            margin: 0 auto;
        }
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-container {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            margin: 16px;
        }
        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-surface-50">
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="hamburger-btn" onclick="toggleMobileSidebar()">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="flex items-center space-x-3">
            <img src="../logo.jpg" alt="로고" class="w-8 h-8 rounded-lg">
            <h1 class="text-lg font-semibold text-gray-800">사장님 플러스 헬프센터</h1>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-mobile-overlay" onclick="toggleMobileSidebar()"></div>

    <div class="app-container">
        <!-- 1계층: 기능 목록 -->
        <div id="function-sidebar" class="mobile-sidebar bg-white border-r border-gray-200 flex flex-col sidebar-transition relative" style="grid-area: sidebar;">
            <button class="toggle-btn" onclick="toggleFunctionSidebar()">
                <span id="function-toggle-icon">‹</span>
            </button>

            <!-- 헤더 -->
            <div class="p-4 lg:p-6 border-b border-gray-200 bg-gradient-to-r from-primary-50 to-white">
                <div class="flex items-center space-x-3 mb-3">
                    <img src="../logo.jpg" alt="로고" class="w-10 h-10 rounded-xl shadow-sm sidebar-text">
                    <div class="sidebar-text">
                        <h2 class="text-lg lg:text-xl font-bold bg-gradient-to-r from-primary-600 to-primary-800 bg-clip-text text-transparent">사장님 플러스</h2>
                        <p class="text-sm text-gray-600 font-medium">헬프센터</p>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mb-4 sidebar-text">수행할 작업을 선택하세요</p>
                <div class="space-y-2 sidebar-text">
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="cookie-sync-btn" class="flex items-center justify-center px-3 py-2 text-xs bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:from-purple-700 hover:to-purple-800 transition-all shadow-sm">
                            🍪 쿠키 동기화
                        </button>
                        <button id="token-sync-btn" class="flex items-center justify-center px-3 py-2 text-xs bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 transition-all shadow-sm">
                            🔄 토큰 동기화
                        </button>
                    </div>
                    <div id="token-status" class="text-xs text-gray-500 bg-gray-50 rounded-md px-3 py-2 border">상태: 확인중...</div>
                </div>
            </div>

            <!-- 어드민 기능목록 토글 헤더 -->
            <div class="function-toggle px-4 py-2 bg-gray-50 border-b border-gray-200 flex items-center justify-between sidebar-text" onclick="toggleAdminFunctions()">
                <span class="font-medium text-gray-700">어드민 기능목록</span>
                <span id="admin-functions-arrow" class="text-gray-500">▼</span>
            </div>

            <!-- 어드민 기능 목록 -->
            <div class="admin-functions" style="display: none;">
                <div class="function-item p-4 cursor-pointer border-b border-gray-100 hover:bg-blue-50" data-function="qr-create">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="text-blue-600 sidebar-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </div>
                            <div class="sidebar-text">
                                <div class="font-medium text-gray-800">가맹점 생성 및 QR 활성화</div>
                                <div class="text-xs text-gray-500 mt-1">3개 어드민 연관</div>
                            </div>
                        </div>
                        <div class="text-gray-400 sidebar-text">→</div>
                    </div>
                </div>

                <div class="function-item p-4 cursor-pointer border-b border-gray-100 hover:bg-blue-50" data-function="qr-recovery">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="text-blue-600 sidebar-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <div class="sidebar-text">
                                <div class="font-medium text-gray-800">가맹점 QR 복구</div>
                                <div class="text-xs text-gray-500 mt-1">3개 어드민 연관</div>
                            </div>
                        </div>
                        <div class="text-gray-400 sidebar-text">→</div>
                    </div>
                </div>

                <div class="function-item p-4 cursor-pointer border-b border-gray-100 hover:bg-blue-50" data-function="permission">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="text-blue-600 sidebar-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                            </div>
                            <div class="sidebar-text">
                                <div class="font-medium text-gray-800">매장 권한변경</div>
                                <div class="text-xs text-gray-500 mt-1">3개 어드민 연관</div>
                            </div>
                        </div>
                        <div class="text-gray-400 sidebar-text">→</div>
                    </div>
                </div>
            </div>

            <!-- 데이터 생성 토글 헤더 -->
            <div class="function-toggle px-4 py-2 bg-gray-50 border-b border-gray-200 flex items-center justify-between sidebar-text" onclick="toggleDataGenerator()">
                <span class="font-medium text-gray-700">데이터 생성</span>
                <span id="data-generator-arrow" class="text-gray-500">▼</span>
            </div>

            <!-- 데이터 생성 목록 -->
            <div class="data-generator-functions" style="display: none;">
                <div class="function-item p-4 cursor-pointer border-b border-gray-100 hover:bg-blue-50" data-function="sample-image-generator">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="text-purple-600 sidebar-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div class="sidebar-text">
                                <div class="font-medium text-gray-800">샘플 이미지 생성</div>
                                <div class="text-xs text-gray-500 mt-1">이미지 생성 도구</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="function-item p-4 cursor-pointer border-b border-gray-100 hover:bg-blue-50" data-function="qr-xlsx-generator">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="text-green-600 sidebar-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                            <div class="sidebar-text">
                                <div class="font-medium text-gray-800">QR XLSX 생성</div>
                                <div class="text-xs text-gray-500 mt-1">QR 엑셀 파일 생성</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="function-item p-4 cursor-pointer border-b border-gray-100 hover:bg-blue-50" data-function="csv-generator">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="text-blue-600 sidebar-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                            <div class="sidebar-text">
                                <div class="font-medium text-gray-800">CSV 생성</div>
                                <div class="text-xs text-gray-500 mt-1">CSV 파일 생성 도구</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2계층: 어드민 목록 -->
        <div id="admin-panel" class="bg-white border-r border-gray-200 flex-col hidden sidebar-transition relative" style="grid-area: admin;">
            <button class="toggle-btn" onclick="toggleAdminPanel()">
                <span id="admin-toggle-icon">‹</span>
            </button>
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 admin-text">어드민 목록</h3>
                <p class="text-sm text-gray-500 mt-1 admin-text" id="function-name">선택된 기능</p>
            </div>
            <div class="flex-1 overflow-y-auto" id="admin-list">
                <!-- 어드민 목록이 여기에 동적으로 추가됩니다 -->
            </div>
        </div>

        <!-- 3계층: 콘텐츠 영역 -->
        <div class="flex flex-col overflow-hidden" style="grid-area: content;">
            <!-- 탭 헤더 -->
            <div id="tab-header" class="bg-white border-b border-gray-200 hidden">
                <div class="flex items-center p-2">
                    <div id="tab-list" class="flex-1 flex items-center space-x-1 overflow-x-auto">
                        <!-- 탭이 여기에 동적으로 추가됩니다 -->
                    </div>
                    <button id="new-tab-btn" class="px-3 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300 ml-2">
                        + 새 탭
                    </button>
                    <button id="new-window-btn" class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 ml-2">
                        + 새 창
                    </button>
                </div>
            </div>

            <!-- 콘텐츠 영역 -->
            <div class="flex-1 bg-white relative" id="content-container">
                <div id="empty-state" class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="text-6xl mb-4">🖥️</div>
                        <h3 class="text-xl font-medium text-gray-500 mb-2">어드민을 선택하세요</h3>
                        <p class="text-gray-400">먼저 수행할 기능을 선택한 후 어드민을 선택하세요</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 쿠키 동기화 모달 -->
    <div id="cookie-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full m-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">🍪 쿠키 관리</h3>
            <div class="mb-4">
                <h4 class="font-medium mb-2">현재 저장된 쿠키:</h4>
                <div id="cookie-list" class="bg-gray-100 p-3 rounded text-sm font-mono max-h-40 overflow-y-auto">
                    로딩중...
                </div>
            </div>
            <div class="mb-4">
                <h4 class="font-medium mb-2">쿠키 추가/수정:</h4>
                <input id="cookie-input" type="text"
                       placeholder="name=value; domain=.example.com; path=/"
                       class="w-full p-2 border rounded text-sm">
                <button onclick="addCookie()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    쿠키 추가
                </button>
            </div>
            <button onclick="closeCookieModal()" class="w-full p-3 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                닫기
            </button>
        </div>
    </div>

    <script>
        // 전역 변수
        const functionData = {
            'qr-create': {
                name: '가맹점 생성 및 QR 활성화',
                admins: [
                    {
                        name: '와칸다_신청서',
                        url: 'https://www.google.com',
                        desc: '가맹점 신청서 작성',
                        isInternal: false
                    },
                    {
                        name: '와칸다_활성화',
                        url: 'https://www.naver.com',
                        desc: '가맹점 활성화 처리',
                        isInternal: false
                    },
                    {
                        name: '오프라인_QR생성요청',
                        url: 'https://admin.example.com/qr',
                        desc: '오프라인 QR 생성',
                        isInternal: true
                    }
                ]
            },
            'qr-recovery': {
                name: '가맹점 QR 복구',
                admins: [
                    {
                        name: 'QR 관리',
                        url: 'https://admin.example.com/qr-manage',
                        desc: 'QR 복구',
                        isInternal: true
                    },
                    {
                        name: '로그 관리',
                        url: 'https://admin.example.com/logs',
                        desc: '로그 확인',
                        isInternal: true
                    },
                    {
                        name: '가맹점 관리',
                        url: 'https://www.kakao.com',
                        desc: '상태 확인',
                        isInternal: false
                    }
                ]
            },
            'permission': {
                name: '매장 권한변경',
                admins: [
                    {
                        name: '권한 관리',
                        url: 'https://admin.example.com/permissions',
                        desc: '권한 설정',
                        isInternal: true
                    },
                    {
                        name: '사용자 관리',
                        url: 'https://admin.example.com/users',
                        desc: '역할 관리',
                        isInternal: true
                    },
                    {
                        name: '감사 관리',
                        url: 'https://www.youtube.com',
                        desc: '변경 이력',
                        isInternal: false
                    }
                ]
            }
        };

        let selectedFunction = null;
        let selectedAdmin = null;
        let windowRefs = {};
        let tabs = [];
        let activeTabId = null;
        let tabCounter = 0;

        // 유틸리티 함수들
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `success-toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showLoadingState(container) {
            container.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-gray-500">로딩 중...</p>
                    </div>
                </div>
            `;
        }

        function showErrorState(container, message) {
            container.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="error-container max-w-md text-center">
                        <div class="text-4xl mb-4">⚠️</div>
                        <h3 class="text-lg font-medium text-red-700 mb-2">오류 발생</h3>
                        <p class="text-red-600 mb-4">${message}</p>
                        <button onclick="location.reload()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                            다시 시도
                        </button>
                    </div>
                </div>
            `;
        }

        // 샘플 이미지 생성기 함수들
        function generateSampleImage() {
            try {
                const size = document.getElementById('sample-imageSize').value;
                const [width, height] = size.split('x').map(Number);
                const bgColor = document.getElementById('sample-bgColor').value;
                const text = document.getElementById('sample-imageText').value;
                const count = parseInt(document.getElementById('sample-imageCount').value) || 1;

                // 포맷 체크
                const formats = [];
                document.querySelectorAll('input[name="imageFormat"]:checked').forEach(el => {
                    formats.push(el.value);
                });

                if (formats.length === 0) {
                    alert('최소 하나의 이미지 포맷을 선택해주세요.');
                    return;
                }

                const canvas = document.getElementById('sample-canvas');
                const ctx = canvas.getContext('2d');

                canvas.width = width;
                canvas.height = height;
                canvas.style.maxWidth = '100%';
                canvas.style.height = 'auto';

                // 첫 번째 이미지 미리보기
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, width, height);

                ctx.fillStyle = '#333333';
                ctx.font = Math.max(16, width/20) + 'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(text, width/2, height/2 - Math.max(20, width/20));

                // 숫자 표시
                ctx.font = Math.max(40, width/10) + 'px Arial';
                ctx.fillText('1', width/2, height/2 + Math.max(20, width/20));

                ctx.font = Math.max(12, width/30) + 'px Arial';
                ctx.fillText(width + ' × ' + height, width/2, height - Math.max(20, width/30));

                // 전역 변수에 설정 저장
                window.sampleImageSettings = {
                    width, height, bgColor, text, count, formats
                };

                document.getElementById('sample-downloadBtn').disabled = false;
            } catch (error) {
                console.error('이미지 생성 오류:', error);
                alert('이미지 생성 중 오류가 발생했습니다.');
            }
        }

        function downloadSampleImage() {
            try {
                const settings = window.sampleImageSettings;
                if (!settings) {
                    alert('먼저 이미지를 생성해주세요.');
                    return;
                }

                const { width, height, bgColor, text, count, formats } = settings;
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                canvas.width = width;
                canvas.height = height;

                for (let i = 1; i <= count; i++) {
                    // 캔버스 초기화
                    ctx.fillStyle = bgColor;
                    ctx.fillRect(0, 0, width, height);

                    ctx.fillStyle = '#333333';
                    ctx.font = Math.max(16, width/20) + 'px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(text, width/2, height/2 - Math.max(20, width/20));

                    // 숫자 표시
                    ctx.font = Math.max(40, width/10) + 'px Arial';
                    ctx.fillText(i.toString(), width/2, height/2 + Math.max(20, width/20));

                    ctx.font = Math.max(12, width/30) + 'px Arial';
                    ctx.fillText(width + ' × ' + height, width/2, height - Math.max(20, width/30));

                    // 각 포맷으로 다운로드
                    formats.forEach(format => {
                        const link = document.createElement('a');
                        const ext = format.toLowerCase();
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                        link.download = `sample-image_${timestamp}_${i}.${ext}`;

                        if (ext === 'jpg' || ext === 'jpeg') {
                            link.href = canvas.toDataURL('image/jpeg', 0.9);
                        } else if (ext === 'webp') {
                            link.href = canvas.toDataURL('image/webp', 0.9);
                        } else {
                            link.href = canvas.toDataURL('image/png');
                        }

                        link.click();
                    });
                }

                showToast(`${count}개 이미지 × ${formats.length}개 포맷 = 총 ${count * formats.length}개 파일 다운로드 완료`);
            } catch (error) {
                console.error('다운로드 오류:', error);
                alert('다운로드 중 오류가 발생했습니다.');
            }
        }

        // QR XLSX 생성기 함수
        function generateQRXlsx() {
            try {
                const cid = document.getElementById('qr-cid').value || '';
                const tid = document.getElementById('qr-tid').value || '';
                const region = document.getElementById('qr-region').value || 'JEJU';
                const van = document.getElementById('qr-van').value || 'KIS';
                const phone = document.getElementById('qr-phone').value || '01025710628';
                const remark = document.getElementById('qr-remark').value || '';

                const data = [
                    ['cid', 'tid', '지역코드', 'van', '휴대폰번호', '비고'],
                    [cid, tid, region, van, phone, remark]
                ];

                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'QR_Data');
                const timestamp = new Date().toISOString().split('T')[0];
                const cidPart = cid ? `_${cid}` : '';
                XLSX.writeFile(wb, `QR_Data${cidPart}_${timestamp}.xlsx`);

                document.getElementById('qr-preview').classList.remove('hidden');
            } catch (error) {
                console.error('XLSX 생성 오류:', error);
                alert('XLSX 파일 생성 중 오류가 발생했습니다.');
            }
        }

        // CSV 열 토글 함수
        function toggleCsvColumn(columnNumber) {
            const options = document.getElementById(`col${columnNumber}-options`);
            const checkbox = document.getElementById(`col${columnNumber}-enable`);

            if (checkbox && options) {
                if (checkbox.checked) {
                    options.classList.remove('hidden');
                } else {
                    options.classList.add('hidden');
                }
            }
        }

        // CSV 생성기 함수
        function generateRandomString() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 10; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        let csvData = [];

        function generateCsvFile() {
            try {
                const rowCount = parseInt(document.getElementById('csv-rowCount').value);

                if (rowCount <= 0 || rowCount > 1000) {
                    alert('행 수는 1~1000 범위로 입력해주세요.');
                    return;
                }

                // 열 설정 확인
                const col2Enabled = document.getElementById('col2-enable').checked;
                const col3Enabled = document.getElementById('col3-enable').checked;

                // 데이터 생성
                csvData = [];

                for (let i = 0; i < rowCount; i++) {
                    const row = [];

                    // 1열
                    const col1Type = document.querySelector('input[name="col1Type"]:checked').value;
                    if (col1Type === 'random') {
                        const col1Text = document.getElementById('col1-text').value || 'Data';
                        row.push(col1Text);
                    } else {
                        row.push(generateRandomString());
                    }

                    // 2열
                    if (col2Enabled) {
                        const col2Type = document.querySelector('input[name="col2Type"]:checked').value;
                        if (col2Type === 'random') {
                            const col2Text = document.getElementById('col2-text').value || 'Data';
                            row.push(col2Text);
                        } else {
                            row.push(generateRandomString());
                        }
                    }

                    // 3열
                    if (col3Enabled) {
                        const col3Type = document.querySelector('input[name="col3Type"]:checked').value;
                        if (col3Type === 'random') {
                            const col3Text = document.getElementById('col3-text').value || 'Data';
                            row.push(col3Text);
                        } else {
                            row.push(generateRandomString());
                        }
                    }

                    csvData.push(row);
                }

                // 미리보기 표시
                displayCsvPreview();

            } catch (error) {
                console.error('CSV 생성 오류:', error);
                alert('CSV 파일 생성 중 오류가 발생했습니다.');
            }
        }

        function displayCsvPreview() {
            const previewDiv = document.getElementById('csv-preview');
            const tbody = document.getElementById('csv-preview-body');

            if (!tbody) {
                previewDiv.classList.remove('hidden');
                return;
            }

            tbody.innerHTML = '';

            // 처음 10개 행만 표시
            const previewRows = Math.min(10, csvData.length);
            for (let i = 0; i < previewRows; i++) {
                const tr = document.createElement('tr');
                csvData[i].forEach(cell => {
                    const td = document.createElement('td');
                    td.className = 'border border-gray-300 px-4 py-2';
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            }

            if (csvData.length > 10) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = csvData[0].length;
                td.className = 'border border-gray-300 px-4 py-2 text-center text-gray-500';
                td.textContent = `... 외 ${csvData.length - 10}개 행`;
                tr.appendChild(td);
                tbody.appendChild(tr);
            }

            previewDiv.classList.remove('hidden');
        }

        function downloadCsv() {
            if (csvData.length === 0) {
                alert('먼저 CSV를 생성해주세요.');
                return;
            }

            let csvContent = '';
            csvData.forEach(row => {
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const rowCount = csvData.length;
            link.setAttribute('download', `custom_data_${rowCount}rows_${timestamp}.csv`);
            link.click();

            showToast('CSV 파일이 다운로드되었습니다.');
        }

        // 쿠키 관리 함수
        function getAllCookies() {
            const cookies = {};
            document.cookie.split(';').forEach(cookie => {
                const [name, value] = cookie.trim().split('=');
                if (name) cookies[name] = value || '';
            });
            return cookies;
        }

        function setCookie(name, value, options = {}) {
            let cookieString = `${name}=${value}`;

            if (options.domain) cookieString += `; domain=${options.domain}`;
            if (options.path) cookieString += `; path=${options.path}`;
            if (options.expires) cookieString += `; expires=${options.expires}`;
            if (options.maxAge) cookieString += `; max-age=${options.maxAge}`;
            if (options.secure) cookieString += '; secure';
            if (options.sameSite) cookieString += `; samesite=${options.sameSite}`;

            document.cookie = cookieString;
        }

        function showCookieModal() {
            const modal = document.getElementById('cookie-modal');
            modal.classList.remove('hidden');
            updateCookieList();
        }

        function closeCookieModal() {
            document.getElementById('cookie-modal').classList.add('hidden');
        }

        function updateCookieList() {
            const cookies = getAllCookies();
            const cookieList = document.getElementById('cookie-list');

            if (Object.keys(cookies).length === 0) {
                cookieList.textContent = '쿠키가 없습니다.';
            } else {
                cookieList.innerHTML = Object.entries(cookies)
                    .map(([name, value]) => `<div class="mb-1"><strong>${name}</strong> = ${value}</div>`)
                    .join('');
            }
        }

        function addCookie() {
            const input = document.getElementById('cookie-input').value.trim();
            if (!input) {
                alert('쿠키 정보를 입력해주세요.');
                return;
            }

            try {
                const parts = input.split(';').map(p => p.trim());
                const [name, value] = parts[0].split('=');

                if (!name) {
                    alert('쿠키 이름이 필요합니다.');
                    return;
                }

                const options = {};
                parts.slice(1).forEach(part => {
                    const [key, val] = part.split('=');
                    if (key) {
                        options[key.toLowerCase()] = val || true;
                    }
                });

                setCookie(name, value || '', options);
                updateCookieList();
                document.getElementById('cookie-input').value = '';
                showToast('쿠키가 추가되었습니다.');
            } catch (e) {
                console.error('쿠키 추가 오류:', e);
                alert('올바른 쿠키 형식이 아닙니다. 예: name=value; domain=.example.com');
            }
        }

        // 토큰 관리 함수
        function getStoredTokens() {
            const tokens = {
                localStorage: {},
                sessionStorage: {},
                cookies: {}
            };

            try {
                // localStorage 토큰
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('token') || key.includes('auth') || key.includes('session'))) {
                        tokens.localStorage[key] = localStorage.getItem(key);
                    }
                }

                // sessionStorage 토큰
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key && (key.includes('token') || key.includes('auth') || key.includes('session'))) {
                        tokens.sessionStorage[key] = sessionStorage.getItem(key);
                    }
                }

                // 쿠키 토큰
                const cookies = getAllCookies();
                Object.entries(cookies).forEach(([name, value]) => {
                    if (name.includes('token') || name.includes('auth') || name.includes('session')) {
                        tokens.cookies[name] = value;
                    }
                });
            } catch (error) {
                console.error('토큰 조회 오류:', error);
            }

            return tokens;
        }

        function updateTokenStatus() {
            try {
                const tokens = getStoredTokens();
                const statusEl = document.getElementById('token-status');

                const totalCount =
                    Object.keys(tokens.localStorage).length +
                    Object.keys(tokens.sessionStorage).length +
                    Object.keys(tokens.cookies).length;

                if (totalCount > 0) {
                    statusEl.innerHTML =
                        `<span class="text-green-600">✅ 토큰 ${totalCount}개 발견</span>` +
                        `<span class="text-xs text-gray-500 block">` +
                            `Local: ${Object.keys(tokens.localStorage).length}, ` +
                            `Session: ${Object.keys(tokens.sessionStorage).length}, ` +
                            `Cookie: ${Object.keys(tokens.cookies).length}` +
                        `</span>`;
                } else {
                    statusEl.innerHTML = '<span class="text-red-600">❌ 토큰 없음</span>';
                }
            } catch (error) {
                console.error('토큰 상태 업데이트 오류:', error);
                document.getElementById('token-status').innerHTML = '<span class="text-red-600">❌ 오류</span>';
            }
        }

        function syncTokens() {
            try {
                const tokens = getStoredTokens();
                console.log('동기화할 토큰:', tokens);

                // 열려있는 모든 창에 토큰 전송 시도
                Object.values(windowRefs).forEach(win => {
                    if (win && !win.closed) {
                        try {
                            win.postMessage({
                                type: 'SYNC_TOKENS',
                                tokens: tokens
                            }, '*');
                        } catch (e) {
                            console.log('토큰 전송 실패:', e);
                        }
                    }
                });

                showToast('토큰 동기화를 시도했습니다. 개발자 콘솔을 확인하세요.');
            } catch (error) {
                console.error('토큰 동기화 오류:', error);
                showToast('토큰 동기화 중 오류가 발생했습니다.', 'error');
            }
        }

        // UI 함수
        function selectFunction(funcId, element) {
            try {
                // 데이터 생성 도구 목록의 활성화 스타일 제거
                document.querySelectorAll('.data-generator-functions .function-item').forEach(item => {
                    item.classList.remove('bg-blue-100');
                });

                // 기존 탭들 모두 정리
                clearAllTabs();

                selectedFunction = funcId;
                selectedAdmin = null;

                document.querySelectorAll('.function-item').forEach(item => {
                    item.classList.remove('function-selected');
                });
                element.classList.add('function-selected');

                const adminPanel = document.getElementById('admin-panel');
                adminPanel.classList.remove('hidden');
                adminPanel.classList.add('flex');

                document.getElementById('function-name').textContent = functionData[funcId].name;

                const adminList = document.getElementById('admin-list');
                adminList.innerHTML = '';

                functionData[funcId].admins.forEach((admin, index) => {
                    const adminItem = document.createElement('div');
                    adminItem.className = 'admin-item p-4 cursor-pointer border-b border-gray-100 hover:bg-green-50';
                    adminItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded flex-shrink-0">${index + 1}</span>
                            <div class="flex-1 ml-3 admin-text">
                                <div class="font-medium text-gray-800 flex items-center space-x-2">
                                    <span>${admin.name}</span>
                                    ${admin.isInternal ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">내부</span>' : ''}
                                </div>
                                <div class="text-sm text-gray-500 mt-1">${admin.desc}</div>
                                <div class="text-xs text-gray-400 mt-1 truncate">${admin.url}</div>
                            </div>
                            <div class="text-gray-400 admin-text ml-2">→</div>
                        </div>
                    `;

                    adminItem.addEventListener('click', () => selectAdmin(admin, adminItem));
                    adminList.appendChild(adminItem);
                });

                // 빈 상태 표시
                const contentContainer = document.getElementById('content-container');
                contentContainer.innerHTML = `
                    <div id="empty-state" class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="text-6xl mb-4">🖥️</div>
                            <h3 class="text-xl font-medium text-gray-500 mb-2">어드민을 선택하세요</h3>
                            <p class="text-gray-400">왼쪽에서 어드민을 선택하세요</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('기능 선택 오류:', error);
                showToast('기능 선택 중 오류가 발생했습니다.', 'error');
            }
        }

        function selectAdmin(admin, element) {
            try {
                selectedAdmin = admin;

                document.querySelectorAll('.admin-item').forEach(item => {
                    item.classList.remove('admin-selected');
                });
                element.classList.add('admin-selected');

                openAdminPage(admin);
            } catch (error) {
                console.error('어드민 선택 오류:', error);
                showToast('어드민 선택 중 오류가 발생했습니다.', 'error');
            }
        }

        function openAdminPage(admin) {
            try {
                if (admin.isInternal) {
                    createTab(admin);
                } else {
                    const windowName = 'admin_' + admin.name.replace(/\s/g, '_');
                    const windowFeatures = 'width=1200,height=800,menubar=yes,toolbar=yes,location=yes,status=yes,scrollbars=yes,resizable=yes';

                    const win = window.open(admin.url, windowName, windowFeatures);
                    if (win) {
                        windowRefs[windowName] = win;

                        const emptyState = document.getElementById('empty-state');
                        emptyState.innerHTML = `
                            <div class="text-center">
                                <div class="text-6xl mb-4">🪟</div>
                                <h3 class="text-xl font-medium text-gray-700 mb-2">${admin.name}</h3>
                                <p class="text-gray-500 mb-4">새 창에서 열렸습니다</p>
                                <div class="space-y-2">
                                    <button onclick="focusWindow('${windowName}')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                        창으로 이동
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        showToast('팝업이 차단되었습니다. 팝업 허용 후 다시 시도하세요.', 'error');
                    }
                }
            } catch (error) {
                console.error('어드민 페이지 열기 오류:', error);
                showToast('페이지를 열 수 없습니다.', 'error');
            }
        }

        // 탭 관리 함수들
        function clearAllTabs() {
            try {
                // 모든 탭 제거
                tabs.forEach(tab => {
                    const tabElement = document.getElementById(`tab-${tab.id}`);
                    const tabContent = document.getElementById(`tab-content-${tab.id}`);
                    if (tabElement) tabElement.remove();
                    if (tabContent) tabContent.remove();
                });

                // 탭 배열 초기화
                tabs = [];
                activeTabId = null;

                // 탭 리스트 비우기
                const tabList = document.getElementById('tab-list');
                if (tabList) {
                    tabList.innerHTML = '';
                }

                // 탭 헤더 숨기기
                document.getElementById('tab-header').classList.add('hidden');
            } catch (error) {
                console.error('탭 정리 오류:', error);
            }
        }

        function createTab(admin) {
            try {
                const tabId = ++tabCounter;
                const tab = {
                    id: tabId,
                    admin: admin,
                    active: false
                };
                tabs.push(tab);

                // 탭 헤더 추가
                const tabElement = document.createElement('div');
                tabElement.id = `tab-${tabId}`;
                tabElement.className = 'flex items-center px-3 py-1 bg-gray-200 rounded cursor-pointer hover:bg-gray-300';
                tabElement.innerHTML = `
                    <span class="text-sm truncate max-w-[150px]">${admin.name}</span>
                    <button class="ml-2 text-xs hover:text-red-500" onclick="closeTab(${tabId})">×</button>
                `;
                tabElement.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'BUTTON') {
                        activateTab(tabId);
                    }
                });

                document.getElementById('tab-list').appendChild(tabElement);

                // 탭 콘텐츠 추가
                const tabContent = document.createElement('div');
                tabContent.id = `tab-content-${tabId}`;
                tabContent.className = 'absolute inset-0 bg-white hidden flex flex-col';
                tabContent.innerHTML = `
                    <div class="bg-gray-100 p-2 border-b flex items-center space-x-2 flex-shrink-0">
                        <button class="nav-btn px-2 py-1 bg-gray-200 rounded text-xs hover:bg-gray-300" onclick="navigateTab(${tabId}, 'back')">←</button>
                        <button class="nav-btn px-2 py-1 bg-gray-200 rounded text-xs hover:bg-gray-300" onclick="navigateTab(${tabId}, 'forward')">→</button>
                        <button class="nav-btn px-2 py-1 bg-gray-200 rounded text-xs hover:bg-gray-300" onclick="navigateTab(${tabId}, 'refresh')">⟳</button>
                        <input class="address-bar flex-1 px-2 py-1 border rounded text-xs" value="${admin.url}" id="address-${tabId}" onkeypress="handleAddressKeypress(event, ${tabId})">
                        <button class="nav-btn px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600" onclick="navigateTab(${tabId}, 'go')">이동</button>
                        <button class="nav-btn px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600" onclick="openInNewWindow('${admin.url}')">🪟</button>
                    </div>
                    <div class="flex-1 relative">
                        <iframe src="${admin.url}"
                                class="w-full h-full border-0"
                                id="iframe-${tabId}"
                                sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-top-navigation">
                        </iframe>
                    </div>
                `;

                document.getElementById('content-container').appendChild(tabContent);

                // 탭 헤더 표시
                document.getElementById('tab-header').classList.remove('hidden');
                document.getElementById('empty-state').classList.add('hidden');

                // 탭 활성화
                activateTab(tabId);

                // iframe 로드 이벤트 처리
                const iframe = document.getElementById(`iframe-${tabId}`);
                iframe.addEventListener('load', () => {
                    handleIframeLoad(iframe, admin);
                });

                iframe.addEventListener('error', () => {
                    showErrorState(iframe.parentElement, '페이지를 로드할 수 없습니다.');
                });
            } catch (error) {
                console.error('탭 생성 오류:', error);
                showToast('탭 생성 중 오류가 발생했습니다.', 'error');
            }
        }

        function activateTab(tabId) {
            try {
                activeTabId = tabId;

                // 모든 탭 비활성화
                tabs.forEach(tab => {
                    const tabElement = document.getElementById(`tab-${tab.id}`);
                    const tabContent = document.getElementById(`tab-content-${tab.id}`);
                    if (tabElement) tabElement.classList.remove('tab-active');
                    if (tabContent) tabContent.classList.add('hidden');
                    tab.active = false;
                });

                // 선택된 탭 활성화
                const selectedTab = tabs.find(t => t.id === tabId);
                if (selectedTab) {
                    const tabElement = document.getElementById(`tab-${tabId}`);
                    const tabContent = document.getElementById(`tab-content-${tabId}`);
                    if (tabElement) tabElement.classList.add('tab-active');
                    if (tabContent) tabContent.classList.remove('hidden');
                    selectedTab.active = true;
                }
            } catch (error) {
                console.error('탭 활성화 오류:', error);
            }
        }

        function closeTab(tabId) {
            try {
                const index = tabs.findIndex(t => t.id === tabId);
                if (index > -1) {
                    tabs.splice(index, 1);

                    const tabElement = document.getElementById(`tab-${tabId}`);
                    const tabContent = document.getElementById(`tab-content-${tabId}`);
                    if (tabElement) tabElement.remove();
                    if (tabContent) tabContent.remove();

                    if (tabs.length === 0) {
                        document.getElementById('tab-header').classList.add('hidden');
                        document.getElementById('empty-state').classList.remove('hidden');
                    } else if (activeTabId === tabId && tabs.length > 0) {
                        activateTab(tabs[tabs.length - 1].id);
                    }
                }
            } catch (error) {
                console.error('탭 닫기 오류:', error);
            }
        }

        function handleIframeLoad(iframe, admin) {
            try {
                // 동일 출처일 때만 접근 가능
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // 401 에러 체크
                if (iframeDoc.title.includes('401') ||
                    iframeDoc.body.textContent.includes('Unauthorized') ||
                    iframeDoc.body.textContent.includes('401')) {

                    console.log('401 에러 감지됨');

                    // 기존 경고 제거
                    const existingTip = iframe.parentElement.querySelector('.auth-warning');
                    if (existingTip) existingTip.remove();

                    // 새 경고 표시
                    const tipDiv = document.createElement('div');
                    tipDiv.className = 'auth-warning absolute top-0 left-0 right-0 bg-yellow-50 border-b border-yellow-200 p-3 z-10';
                    tipDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-yellow-600">⚠️</span>
                                <span class="text-sm text-yellow-800">401 에러가 발생했습니다. 쿠키 동기화를 시도하거나 페이지를 새로고침하세요.</span>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="text-yellow-600 hover:text-yellow-800">×</button>
                        </div>
                    `;
                    iframe.parentElement.appendChild(tipDiv);
                }
            } catch (e) {
                // Cross-origin 제한으로 접근 불가 (정상적인 상황)
                console.log('iframe 콘텐츠 접근 불가 (cross-origin)');
            }
        }

        // 네비게이션 함수들
        function navigateTab(tabId, action) {
            try {
                const iframe = document.getElementById(`iframe-${tabId}`);
                const addressBar = document.getElementById(`address-${tabId}`);

                if (!iframe || !addressBar) return;

                switch (action) {
                    case 'back':
                        try {
                            iframe.contentWindow.history.back();
                        } catch (e) {
                            console.log('뒤로가기 실패:', e);
                        }
                        break;
                    case 'forward':
                        try {
                            iframe.contentWindow.history.forward();
                        } catch (e) {
                            console.log('앞으로가기 실패:', e);
                        }
                        break;
                    case 'refresh':
                        iframe.src = iframe.src;
                        break;
                    case 'go':
                        const url = addressBar.value;
                        if (url && url.trim()) {
                            if (isValidUrl(url.trim())) {
                                iframe.src = url.trim();
                            } else {
                                showToast('올바른 URL 형식이 아닙니다.', 'error');
                            }
                        }
                        break;
                }
            } catch (error) {
                console.error('네비게이션 오류:', error);
                showToast('네비게이션 중 오류가 발생했습니다.', 'error');
            }
        }

        function handleAddressKeypress(event, tabId) {
            if (event.key === 'Enter') {
                navigateTab(tabId, 'go');
            }
        }

        function openInNewWindow(url) {
            try {
                if (!isValidUrl(url)) {
                    showToast('올바른 URL이 아닙니다.', 'error');
                    return;
                }

                const windowFeatures = 'width=1200,height=800,menubar=yes,toolbar=yes,location=yes,status=yes,scrollbars=yes,resizable=yes';
                const win = window.open(url, '_blank', windowFeatures);

                if (!win) {
                    showToast('팝업이 차단되었습니다. 팝업 허용 후 다시 시도하세요.', 'error');
                }
            } catch (error) {
                console.error('새 창 열기 오류:', error);
                showToast('새 창을 열 수 없습니다.', 'error');
            }
        }

        function focusWindow(windowName) {
            try {
                const win = windowRefs[windowName];
                if (win && !win.closed) {
                    win.focus();
                } else {
                    showToast('창이 닫혔습니다. 다시 선택해주세요.', 'error');
                    delete windowRefs[windowName];
                }
            } catch (error) {
                console.error('창 포커스 오류:', error);
                showToast('창에 접근할 수 없습니다.', 'error');
            }
        }

        // 모바일 사이드바 토글 함수
        function toggleMobileSidebar() {
            try {
                const sidebar = document.getElementById('function-sidebar');
                const overlay = document.querySelector('.sidebar-mobile-overlay');
                
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                
                // 모바일에서 body 스크롤 방지
                if (sidebar.classList.contains('active')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            } catch (error) {
                console.error('모바일 사이드바 토글 오류:', error);
            }
        }

        // 사이드바 토글 함수들
        function toggleFunctionSidebar() {
            try {
                const sidebar = document.getElementById('function-sidebar');
                const adminPanel = document.getElementById('admin-panel');
                const icon = document.getElementById('function-toggle-icon');

                // 데스크톱에서만 작동 (모바일은 별도 처리)
                if (window.innerWidth > 768) {
                    sidebar.classList.toggle('sidebar-collapsed');

                    if (sidebar.classList.contains('sidebar-collapsed')) {
                        icon.textContent = '›';
                        // 기능 목록이 접히면 어드민 패널도 숨김
                        adminPanel.classList.add('hidden');
                        adminPanel.classList.remove('flex');
                    } else {
                        icon.textContent = '‹';
                    }
                }
            } catch (error) {
                console.error('사이드바 토글 오류:', error);
            }
        }

        function toggleDataGenerator() {
            try {
                const dataGeneratorFunctions = document.querySelector('.data-generator-functions');
                const arrow = document.getElementById('data-generator-arrow');

                if (dataGeneratorFunctions.style.display === 'none') {
                    dataGeneratorFunctions.style.display = 'block';
                    arrow.textContent = '▲';
                } else {
                    dataGeneratorFunctions.style.display = 'none';
                    arrow.textContent = '▼';
                }
            } catch (error) {
                console.error('데이터 생성기 토글 오류:', error);
            }
        }

        function toggleAdminFunctions() {
            try {
                const adminFunctions = document.querySelector('.admin-functions');
                const arrow = document.getElementById('admin-functions-arrow');

                if (adminFunctions.style.display === 'none') {
                    adminFunctions.style.display = 'block';
                    arrow.textContent = '▲';
                } else {
                    adminFunctions.style.display = 'none';
                    arrow.textContent = '▼';
                }
            } catch (error) {
                console.error('어드민 기능 토글 오류:', error);
            }
        }

        function openAdminFunction(functionId) {
            selectFunction(functionId, document.querySelector(`[data-function="${functionId}"]`));
        }

        // 직접 도구 열기 함수 (2단계 메뉴 없이 바로 도구 표시)
        function openDirectTool(toolId) {
            try {
                // 어드민 기능 목록의 활성화 스타일 제거
                document.querySelectorAll('.admin-functions .function-item').forEach(item => {
                    item.classList.remove('bg-blue-100');
                });

                // 기존 탭들 모두 정리
                clearAllTabs();

                // 어드민 패널 숨기기
                const adminPanel = document.getElementById('admin-panel');
                adminPanel.classList.add('hidden');

                // 탭 헤더 숨기기
                document.getElementById('tab-header').classList.add('hidden');

                // 빈 상태 숨기기
                const emptyState = document.getElementById('empty-state');
                if (emptyState) {
                    emptyState.style.display = 'none';
                }

                // 기존 콘텐츠 정리
                const contentContainer = document.getElementById('content-container');
                let toolHTML = '';

                // 로딩 상태 표시
                showLoadingState(contentContainer);

                setTimeout(() => {
                    switch(toolId) {
                        case 'sample-image-generator':
                            toolHTML = getSampleImageGeneratorHTML();
                            break;
                        case 'qr-xlsx-generator':
                            toolHTML = getQRXlsxGeneratorHTML();
                            break;
                        case 'csv-generator':
                            toolHTML = getCsvGeneratorHTML();
                            break;
                        default:
                            toolHTML = '<div class="p-8 text-center text-red-500">도구를 찾을 수 없습니다.</div>';
                    }

                    // 메인 콘텐츠 영역에 도구 표시
                    contentContainer.innerHTML = toolHTML;

                    // 샘플 이미지 생성기인 경우 초기 이미지 생성
                    if (toolId === 'sample-image-generator') {
                        setTimeout(generateSampleImage, 100);
                    }
                }, 300);
            } catch (error) {
                console.error('직접 도구 열기 오류:', error);
                showErrorState(document.getElementById('content-container'), '도구를 로드할 수 없습니다.');
            }
        }

        function toggleAdminPanel() {
            try {
                const panel = document.getElementById('admin-panel');
                const icon = document.getElementById('admin-toggle-icon');

                panel.classList.toggle('admin-panel-collapsed');

                if (panel.classList.contains('admin-panel-collapsed')) {
                    icon.textContent = '›';
                } else {
                    icon.textContent = '‹';
                }
            } catch (error) {
                console.error('어드민 패널 토글 오류:', error);
            }
        }

        // 도구 HTML 생성 함수들
        function getSampleImageGeneratorHTML() {
            return `
                <div class="h-full overflow-auto bg-white">
                    <div class="p-6 border-b border-gray-200">
                        <h1 class="text-2xl font-bold text-gray-800">샘플 이미지 생성기</h1>
                        <p class="text-gray-600 mt-2">다양한 포맷의 샘플 이미지를 생성할 수 있습니다.</p>
                    </div>
                    <div class="p-6">
                        <div class="max-w-2xl mx-auto">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">이미지 크기</label>
                                        <select id="sample-imageSize" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                            <option value="100x100">100x100</option>
                                            <option value="200x200">200x200</option>
                                            <option value="400x400" selected>400x400</option>
                                            <option value="800x600">800x600</option>
                                            <option value="1920x1080">1920x1080</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">배경색</label>
                                        <input type="color" id="sample-bgColor" value="#f0f0f0" class="w-full h-10 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">텍스트</label>
                                        <input type="text" id="sample-imageText" value="Sample Image" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">생성할 이미지 개수</label>
                                        <input type="number" id="sample-imageCount" value="5" min="1" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">이미지 포맷</label>
                                        <div class="space-y-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" name="imageFormat" value="PNG" checked class="mr-2">
                                                <span>PNG</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="imageFormat" value="JPG" checked class="mr-2">
                                                <span>JPG</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="imageFormat" value="JPEG" checked class="mr-2">
                                                <span>JPEG</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="imageFormat" value="WEBP" checked class="mr-2">
                                                <span>WEBP</span>
                                            </label>
                                        </div>
                                    </div>
                                    <button onclick="generateSampleImage()" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
                                        이미지 생성하기
                                    </button>
                                </div>
                                <div>
                                    <div class="border border-gray-300 rounded-md p-4 bg-gray-50 min-h-64 flex items-center justify-center">
                                        <canvas id="sample-canvas" class="border border-gray-200"></canvas>
                                    </div>
                                    <button id="sample-downloadBtn" onclick="downloadSampleImage()" class="w-full mt-4 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 disabled:opacity-50" disabled>
                                        이미지 다운로드
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getQRXlsxGeneratorHTML() {
            return `
                <div class="h-full overflow-auto bg-white">
                    <div class="p-6 border-b border-gray-200">
                        <h1 class="text-2xl font-bold text-gray-800">QR XLSX 생성기</h1>
                        <p class="text-gray-600 mt-2">QR 코드 정보가 포함된 XLSX 파일을 생성할 수 있습니다.</p>
                    </div>
                    <div class="p-6">
                        <div class="max-w-4xl mx-auto space-y-6">
                            <div class="space-y-4">
                                <div class="border-t pt-4">
                                    <h3 class="text-lg font-medium text-gray-700 mb-4">QR 코드 데이터 필드</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">CID</label>
                                            <input type="text" id="qr-cid" value="" placeholder="빈값" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">TID</label>
                                            <input type="text" id="qr-tid" value="" placeholder="빈값" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">지역코드</label>
                                            <input type="text" id="qr-region" value="JEJU" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">VAN</label>
                                            <input type="text" id="qr-van" value="KIS" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">휴대폰번호</label>
                                            <input type="text" id="qr-phone" value="01025710628" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">비고</label>
                                            <input type="text" id="qr-remark" value="" placeholder="빈값" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button onclick="generateQRXlsx()" class="bg-green-600 text-white py-3 px-6 rounded-md hover:bg-green-700">QR XLSX 파일 생성</button>
                            <div id="qr-preview" class="mt-6 p-4 border border-gray-300 rounded-md bg-gray-50 hidden">
                                <h3 class="text-lg font-medium mb-4">생성 완료!</h3>
                                <p>XLSX 파일이 다운로드되었습니다.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getCsvGeneratorHTML() {
            return `
                <div class="h-full overflow-auto bg-white">
                    <div class="p-6 border-b border-gray-200">
                        <h1 class="text-2xl font-bold text-gray-800">CSV 생성기</h1>
                        <p class="text-gray-600 mt-2">커스텀 CSV 파일을 생성할 수 있습니다.</p>
                    </div>
                    <div class="p-6">
                        <div class="max-w-4xl mx-auto space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">생성할 행 수</label>
                                <input type="number" id="csv-rowCount" value="10" min="1" max="1000" class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-md">
                            </div>

                            <div class="space-y-4">
                                <h3 class="text-lg font-medium text-gray-800">열 설정</h3>

                                <!-- 1열 (필수) -->
                                <div class="p-4 border border-gray-200 rounded-md">
                                    <div class="flex items-center justify-between mb-3">
                                        <span class="font-medium">1열 (필수)</span>
                                    </div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="flex items-center">
                                                <input type="radio" name="col1Type" value="random" checked class="mr-2">
                                                <span>텍스트 입력</span>
                                            </label>
                                            <input type="text" id="col1-text" placeholder="텍스트를 입력하세요" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label class="flex items-center">
                                                <input type="radio" name="col1Type" value="custom" class="mr-2">
                                                <span>난수발생</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- 2열 (선택) -->
                                <div class="p-4 border border-gray-200 rounded-md">
                                    <div class="flex items-center justify-between mb-3">
                                        <span class="font-medium">2열 포함</span>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="col2-enable" checked class="mr-2" onchange="toggleCsvColumn(2)">
                                            <span>사용</span>
                                        </label>
                                    </div>
                                    <div class="space-y-3" id="col2-options">
                                        <div>
                                            <label class="flex items-center">
                                                <input type="radio" name="col2Type" value="random" checked class="mr-2">
                                                <span>텍스트 입력</span>
                                            </label>
                                            <input type="text" id="col2-text" placeholder="텍스트를 입력하세요" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label class="flex items-center">
                                                <input type="radio" name="col2Type" value="custom" class="mr-2">
                                                <span>난수발생</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- 3열 (선택) -->
                                <div class="p-4 border border-gray-200 rounded-md">
                                    <div class="flex items-center justify-between mb-3">
                                        <span class="font-medium">3열 포함</span>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="col3-enable" class="mr-2" onchange="toggleCsvColumn(3)">
                                            <span>사용</span>
                                        </label>
                                    </div>
                                    <div class="space-y-3 hidden" id="col3-options">
                                        <div>
                                            <label class="flex items-center">
                                                <input type="radio" name="col3Type" value="random" checked class="mr-2">
                                                <span>텍스트 입력</span>
                                            </label>
                                            <input type="text" id="col3-text" placeholder="텍스트를 입력하세요" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label class="flex items-center">
                                                <input type="radio" name="col3Type" value="custom" class="mr-2">
                                                <span>난수발생</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button onclick="generateCsvFile()" class="bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700">미리보기</button>

                            <div id="csv-preview" class="mt-6 p-4 border border-gray-300 rounded-md bg-gray-50 hidden">
                                <h3 class="text-lg font-medium mb-4">CSV 미리보기</h3>
                                <div id="csv-preview-content" class="overflow-auto max-h-64">
                                    <table class="min-w-full border-collapse">
                                        <thead>
                                            <tr class="bg-gray-200">
                                                <th class="border border-gray-300 px-4 py-2">1열</th>
                                                <th class="border border-gray-300 px-4 py-2">2열</th>
                                                <th class="border border-gray-300 px-4 py-2">3열</th>
                                            </tr>
                                        </thead>
                                        <tbody id="csv-preview-body">
                                        </tbody>
                                    </table>
                                </div>
                                <button onclick="downloadCsv()" class="mt-4 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                                    CSV 다운로드
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 이벤트 리스너
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // 어드민 기능 항목 클릭 이벤트
                document.querySelectorAll('.admin-functions .function-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const funcId = this.dataset.function;
                        if (funcId) {
                            openAdminFunction(funcId);
                        }
                    });
                });

                // 데이터 생성 도구 항목 클릭 이벤트
                document.querySelectorAll('.data-generator-functions .function-item').forEach(item => {
                    item.addEventListener('click', function() {
                        // 모든 데이터 생성 항목의 활성화 스타일 제거
                        document.querySelectorAll('.data-generator-functions .function-item').forEach(el => {
                            el.classList.remove('bg-blue-100');
                        });
                        // 현재 클릭한 항목에 활성화 스타일 추가
                        this.classList.add('bg-blue-100');
                        
                        const funcId = this.dataset.function;
                        if (funcId) {
                            openDirectTool(funcId);
                        }
                    });
                });

                // 쿠키 동기화 버튼
                const cookieSyncBtn = document.getElementById('cookie-sync-btn');
                if (cookieSyncBtn) {
                    cookieSyncBtn.addEventListener('click', showCookieModal);
                }

                // 토큰 동기화 버튼
                const tokenSyncBtn = document.getElementById('token-sync-btn');
                if (tokenSyncBtn) {
                    tokenSyncBtn.addEventListener('click', syncTokens);
                }

                // 새 탭 버튼
                const newTabBtn = document.getElementById('new-tab-btn');
                if (newTabBtn) {
                    newTabBtn.addEventListener('click', function() {
                        if (selectedAdmin) {
                            createTab(selectedAdmin);
                        } else {
                            showToast('먼저 어드민을 선택하세요.', 'error');
                        }
                    });
                }

                // 새 창 버튼
                const newWindowBtn = document.getElementById('new-window-btn');
                if (newWindowBtn) {
                    newWindowBtn.addEventListener('click', function() {
                        if (selectedAdmin) {
                            openInNewWindow(selectedAdmin.url);
                        } else {
                            showToast('먼저 어드민을 선택하세요.', 'error');
                        }
                    });
                }

                // 쿠키 입력창 엔터키 처리
                const cookieInput = document.getElementById('cookie-input');
                if (cookieInput) {
                    cookieInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            addCookie();
                        }
                    });
                }

                // 초기화
                updateTokenStatus();

                // 주기적으로 토큰 상태 업데이트
                setInterval(updateTokenStatus, 5000);

                console.log('사장님 플러스 헬프센터가 성공적으로 로드되었습니다.');
            } catch (error) {
                console.error('초기화 오류:', error);
                showToast('애플리케이션 초기화 중 오류가 발생했습니다.', 'error');
            }
        });

        // 메시지 수신 (다른 창에서의 토큰 동기화 요청)
        window.addEventListener('message', function(event) {
            try {
                if (event.data && event.data.type === 'REQUEST_TOKENS') {
                    const tokens = getStoredTokens();
                    event.source.postMessage({
                        type: 'SYNC_TOKENS',
                        tokens: tokens
                    }, event.origin);
                }
            } catch (error) {
                console.error('메시지 처리 오류:', error);
            }
        });

        // 에러 전역 처리
        window.addEventListener('error', function(event) {
            console.error('전역 에러:', event.error);
            showToast('예상치 못한 오류가 발생했습니다.', 'error');
        });

        // 글로벌 함수들 (onclick에서 사용)
        window.closeTab = closeTab;
        window.focusWindow = focusWindow;
        window.navigateTab = navigateTab;
        window.handleAddressKeypress = handleAddressKeypress;
        window.openInNewWindow = openInNewWindow;
        window.toggleDataGenerator = toggleDataGenerator;
        window.toggleAdminFunctions = toggleAdminFunctions;
        window.toggleFunctionSidebar = toggleFunctionSidebar;
        window.toggleMobileSidebar = toggleMobileSidebar;
        window.toggleAdminPanel = toggleAdminPanel;
        window.openAdminFunction = openAdminFunction;
        window.openDirectTool = openDirectTool;
        window.showCookieModal = showCookieModal;
        window.closeCookieModal = closeCookieModal;
        window.addCookie = addCookie;
        window.syncTokens = syncTokens;
        window.generateSampleImage = generateSampleImage;
        window.downloadSampleImage = downloadSampleImage;
        window.generateQRXlsx = generateQRXlsx;
        window.generateCsvFile = generateCsvFile;
        window.downloadCsv = downloadCsv;
        window.toggleCsvColumn = toggleCsvColumn;
        <img src="../favicon-32x32.jpg" height="32" width="32"/></script>
</body>
</html>